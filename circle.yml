# CircleCI automatically reads this file from our repo and uses it for
# configuration. Docs: https://circleci.com/docs/configuration
checkout:
  post:
    - git submodule sync
    - git submodule update --init

dependencies:
  pre:
    - curl -o $HOME/google_appengine_1.9.28.zip https://storage.googleapis.com/appengine-sdks/featured/google_appengine_1.9.28.zip
    - unzip -q -d $HOME $HOME/google_appengine_1.9.28.zip
  post:
    - ln -s $VIRTUAL_ENV local  # we use app engine's vendor module to point here
    - pip install coverage coveralls  # for https://coveralls.io/

machine:
  environment:
    PYTHONPATH: $PYTHONPATH:$HOME/google_appengine

test:
  override:
    - python -m coverage run --include=oauth_dropins/webutil/handlers.py,oauth_dropins/webutil/models.py,oauth_dropins/webutil/util.py -m unittest discover -v
    - python -m coverage html -d $CIRCLE_ARTIFACTS
  post:
    - if [ "$COVERALLS_REPO_TOKEN" != "" ]; then coveralls; fi


# continuous deployment! deploy to prod app engine when tests pass on master.
# https://circleci.com/docs/introduction-to-continuous-deployment/
# https://circleci.com/docs/deploy-google-app-engine/
deployment:
  prod:
    branch: master
    commands:
      - ./scripts/deploy.sh --oauth2_access_token=$APP_ENGINE_ACCESS_TOKEN --oauth2_refresh_token=$APP_ENGINE_REFRESH_TOKEN
